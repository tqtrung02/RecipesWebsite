<% if(recipe != null ) { %>

    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Trang chủ</a></li>
        <li class="breadcrumb-item"><a href="/categories/<%- recipe.category %>"><%- recipe.category %></a></li>
        <li class="breadcrumb-item active" aria-current="page"><%- recipe.name %></li>
      </ol>
    </nav>
  
  
    <div class="row">
  
      <div class="col-12 col-md-4">
        <img src="/uploads/<%- recipe.image %>" class="img-fluid sticky-top" style="top: 20px;" alt="<%- recipe.name %>" loading="lazy">
      </div>
  
      <div class="col-12 col-md-8">
        <div class="row">
          <div class="col-12"><h1><%- recipe.name %></h1>
            <% if (user) { %>
              <div class="position-relative">
                <% if (user.favorites.includes(recipe._id.toString())) { %>
                  <!-- Button to remove from favorites (Top-right corner) -->
                  <a href="/recipe/unfavorite/<%= recipe._id %>" class="btn btn-outline-danger btn-lg position-absolute top-0 end-0 m-3" title="Remove from Favorites">
                    <i class="bi bi-heart-fill fs-5"></i> Remove
                  </a>
                <% } else { %>
                  <!-- Button to add to favorites (Top-right corner) -->
                  <a href="/recipe/favorite/<%= recipe._id %>" class="btn btn-outline-danger btn-lg position-absolute top-0 end-0 m-3" title="Add to Favorites">
                    <i class="bi bi-heart fs-5"></i> Add
                  </a>
                <% } %>
              </div>
            <% } %>
          </div>
          <div class="col-12 mb-4"><i class="bi bi-tag"></i> <%- recipe.category %></div>
          <div class="col-12" style="white-space: pre-line;">
            <h4>Công thức</h4>
            <%- recipe.description %>
          </div>
        </div>
  
        <div class="row pt-4">
          <div class="col-12">
            <h4>Nguyên liệu</h4>
            <ul class="list-group list-group-flush">
              <% recipe.ingredients.forEach(function(ingredients, index){ %>
                <li class="list-group-item"><%= ingredients %></li>
              <% }) %>
            </ul> 
          </div>
        </div>
      </div>
    </div>
    <% if (user && (recipe.email === user.email || user.role === 'admin')) { %> <!-- Check if the logged-in user is the owner or admin-->
      <div class="mt-4 d-flex justify-content-end gap-2 me-3">
        <a href="/recipe/edit/<%= recipe._id %>" class="btn btn-outline-warning btn-lg d-flex align-items-center gap-2">
          <i class="bi bi-pencil-square fs-5"></i>
          <span>Sửa công thức</span>
        </a>
        <a href="/recipe/delete/<%= recipe._id %>" class="btn btn-outline-danger btn-lg d-flex align-items-center gap-2"
           onclick="return confirm('Bạn có muốn xóa công thức không ?')">
          <i class="bi bi-trash fs-5"></i>
          <span>Xóa công thức</span>
        </a>
      </div>      
  <% } %>
    <!-- Recipe Comments Section -->
    <div class="row pt-4">
      <div class="col-12">
          <h4 class="text-primary mb-3">Bình luận</h4>

          <% if (recipe.comments.length > 0) { %>
              <div class="comments-list">
                  <% recipe.comments.forEach(function(comment) { %>
                    <div class="comment-item mb-4 p-3 rounded shadow-sm">
                      <div class="d-flex justify-content-between align-items-start">
                          <div>
                              <strong class="fs-5"><%= comment.user.name %></strong>
                              <span class="text-muted small"><%= comment.createdAt.toLocaleString() %></span>
                          </div>  

                          <% if (user && user.role === 'admin') { %>
                              <a href="/recipe/<%= recipe._id %>/comment/delete/<%= comment._id %>" class="btn btn-danger btn-sm ms-3 mt-2" onclick="return confirm('Bạn có chắc chắn muốn xóa bình luận này?')">Xóa</a>
                          <% } %>
                      </div>
                      <p class="mt-2"><%= comment.commentText %></p>
                    </div>
                  <% }); %>
              </div>
          <% } else { %>
              <p class="text-muted">Chưa có bình luận nào. Hãy là người đầu tiên bình luận!</p>
          <% } %>
      </div>
    </div>

    <!-- Add Comment Form -->
    <% if (user) { %>
      <div class="row pt-3">
          <div class="col-12">
              <h5 class="text-primary">Thêm bình luận</h5>
              <form action="/recipe/<%= recipe._id %>/comment" method="POST">
                  <div class="form-group">
                      <textarea name="commentText" class="form-control" placeholder="Thêm bình luận..." rows="4" required></textarea>
                  </div>
                  <button type="submit" class="btn btn-primary mt-2">Đăng bình luận</button>
              </form>
          </div>
      </div>
    <% } else { %>
      <p class="mt-2 text-muted"><a href="/login">Đăng nhập</a> để thêm bình luận.</p>
    <% } %>


  <% } else { %>
    <p>No item found.</p>
  <% } %>